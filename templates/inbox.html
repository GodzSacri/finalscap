<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SecureSys Mail - Inbox</title>
    
    <!-- External Stylesheets -->
    <link rel="stylesheet" href="/static/mess.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Modal Styles -->
    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal.hidden {
            display: none;
        }
        
        .modal-content {
            background: #3b3f9c;
            padding: 25px;
            border-radius: 10px;
            width: 320px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            color: #000;
        }
        
        .modal-content h3 {
            color: #000;
        }
        
        .modal-actions {
            display: flex;
            justify-content: space-between;
        }
        
        .modal-actions button {
            padding: 10px 20px;
            border: none;
            background: #6c63ff;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .modal-actions button:hover {
            background: #5a55d4;
        }
    </style>
</head>

<body>
    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-shield-alt"></i> SecureSys</h2>
            </div>
            
            <div class="user-info">
                <button id="btnLogout" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <button id="btnCompose" class="nav-btn">
                    <i class="fas fa-edit"></i> Compose
                </button>
                <button id="btnInbox" class="nav-btn active">
                    <i class="fas fa-inbox"></i> Inbox
                </button>
                <button id="btnSent" class="nav-btn">
                    <i class="fas fa-paper-plane"></i> Sent
                </button>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="content">
            <section id="inboxSection">
                <div class="section-header">
                    <h3><i class="fas fa-inbox"></i> Inbox</h3>
                    <div>
                        <button id="refreshInbox" class="refresh-btn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="requestOtpBtn" class="refresh-btn">
                            <i class="fas fa-key"></i> Request OTP
                        </button>
                    </div>
                </div>
                
                <div id="messageList" class="message-list">
                    <div class="loading-msg">
                        <i class="fas fa-spinner fa-spin"></i> Loading messages...
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification hidden"></div>
    
    <!-- OTP Modal -->
    <div id="otpModal" class="modal hidden">
        <div class="modal-content">
            <h3>Enter OTP</h3>
            <input type="text" id="otpInput" placeholder="Enter OTP here" maxlength="6" />
            <div class="modal-actions">
                <button id="verifyOtpBtn">Verify</button>
                <button id="cancelOtpBtn">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="/static/mess.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Application Logic -->
    <script>
        // Global Variables
        let selectedMessageId = null;
        
        // Event Listeners
        document.addEventListener("DOMContentLoaded", () => {
            initializeEventListeners();
        });
        
        // Functions
        function initializeEventListeners() {
            // Message selection
            document.addEventListener("click", (e) => {
                const target = e.target.closest(".message-item");
                if (target) {
                    selectedMessageId = target.dataset.id;
                    showOtpModal();
                }
            });
            
            // OTP Modal buttons
            document.getElementById("cancelOtpBtn").addEventListener("click", hideOtpModal);
            document.getElementById("verifyOtpBtn").addEventListener("click", verifyOtp);
            
            // Request OTP button
            document.getElementById("requestOtpBtn").addEventListener("click", requestOtp);
        }
        
        function showOtpModal() {
            const modal = document.getElementById("otpModal");
            modal.classList.remove("hidden");
            document.getElementById("otpInput").value = "";
            document.getElementById("otpInput").focus();
        }
        
        function hideOtpModal() {
            document.getElementById("otpModal").classList.add("hidden");
            selectedMessageId = null;
        }
        
        async function verifyOtp() {
            const otp = document.getElementById("otpInput").value.trim();
            
            if (!otp) {
                UI.showNotification("Please enter the OTP.", true);
                return;
            }
            
            try {
                const res = await API.fetch("/api/verify-otp", {
                    method: "POST",
                    body: JSON.stringify({ otp }),
                });
                
                const data = await res.json();
                
                if (data.success) {
                    hideOtpModal();
                    window.location.href = `/view_message/${selectedMessageId}`;
                } else {
                    UI.showNotification(data.msg || "Invalid OTP", true);
                }
            } catch (err) {
                UI.showNotification(err.message || "Error verifying OTP", true);
            }
        }
        
        async function requestOtp() {
            try {
                const res = await fetch(`${CONFIG.API_URL}/api/request-otp`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${Auth.getToken()}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({}),
                });
                
                if (!res.ok) {
                    throw new Error(`Request failed (${res.status})`);
                }
                
                const data = await res.json();
                UI.showNotification(data.msg || "OTP sent to your Gmail!");
            } catch (err) {
                console.error("OTP Request Error:", err);
                UI.showNotification("Failed to request OTP. Please try again.", true);
            }
        }
    </script>
</body>
</html>